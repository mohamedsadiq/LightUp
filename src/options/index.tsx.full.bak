import { useEffect, useState, useRef } from "react"
import { Storage } from "@plasmohq/storage"
import "./options-style.css"
import type { Settings, ModelType, GeminiModel, GrokModel, LocalModel, Mode } from "~types/settings"
import { motion, AnimatePresence } from "framer-motion"
import { useRateLimit } from "~hooks/useRateLimit"
import ErrorMessage from "~components/common/ErrorMessage"
import { SYSTEM_PROMPTS, USER_PROMPTS } from "../utils/constants"
import styled from "@emotion/styled"
import { css } from "@emotion/react"
import { useSettings } from "~hooks/useSettings"

import logoUrl from '../../assets/lightup.png'

const GEMINI_MODELS: { value: GeminiModel; label: string; description: string }[] = [
  {
    value: "gemini-2.0-flash",
    label: "Gemini 2.0 Flash",
    description: "Latest version with improved capabilities and faster response times"
  },
  {
    value: "gemini-2.0-flash-lite-preview-02-05",
    label: "Gemini 2.0 Flash-Lite",
    description: "Lightweight version optimized for efficiency and speed"
  },
  {
    value: "gemini-2.0-flash-thinking-exp-01-21",
    label: "Gemini 2.0 Flash Thinking",
    description: "Experimental model focused on reasoning and analytical tasks"
  },
  {
    value: "gemini-1.5-pro",
    label: "Gemini 1.5 Pro",
    description: "Stable version with balanced performance"
  },
  {
    value: "gemini-1.5-flash",
    label: "Gemini 1.5 Flash",
    description: "Faster, smaller model for quick responses"
  },
  {
    value: "gemini-1.5-flash-8b",
    label: "Gemini 1.5 Flash-8B",
    description: "8-bit quantized version for efficient processing"
  }
];

const GROK_MODELS: { value: GrokModel; label: string; description: string; price: string }[] = [
  {
    value: "grok-2",
    label: "Grok 2",
    description: "Standard text model with balanced performance",
    price: "$2.00 per 1M tokens"
  },
  {
    value: "grok-2-latest",
    label: "Grok 2 Latest",
    description: "Latest version with improved capabilities",
    price: "$2.00 per 1M tokens"
  },
  {
    value: "grok-beta",
    label: "Grok Beta",
    description: "Beta version with experimental features",
    price: "$5.00 per 1M tokens"
  }
];

const LOCAL_MODELS: { value: LocalModel; label: string; description: string; size: string }[] = [
  {
    value: "llama-2-70b-chat",
    label: "Llama 2 70B Chat",
    description: "Most powerful Llama 2 model, best for complex tasks",
    size: "70B parameters"
  },
  {
    value: "deepseek-v3",
    label: "DeepSeek V3",
    description: "Latest DeepSeek model with enhanced reasoning capabilities",
    size: "67B parameters"
  },
  {
    value: "mixtral-8x7b-instruct",
    label: "Mixtral 8x7B Instruct",
    description: "High-performance mixture of experts model",
    size: "47B parameters"
  },
  {
    value: "llama-2-13b-chat",
    label: "Llama 2 13B Chat",
    description: "Balanced performance and resource usage",
    size: "13B parameters"
  },
  {
    value: "mistral-7b-instruct",
    label: "Mistral 7B Instruct",
    description: "Efficient instruction-following model",
    size: "7B parameters"
  },
  {
    value: "neural-chat-7b-v3-1",
    label: "Neural Chat V3.1",
    description: "Optimized for natural conversations",
    size: "7B parameters"
  },
  {
    value: "deepseek-v3-base",
    label: "DeepSeek V3 Base",
    description: "Lighter version of DeepSeek with good reasoning",
    size: "7B parameters"
  },
  {
    value: "llama-3.2-3b-instruct",
    label: "Llama 3.2 3B Instruct",
    description: "Lightweight model for basic tasks",
    size: "3B parameters"
  },
  {
    value: "phi-2",
    label: "Phi-2",
    description: "Compact but powerful for its size",
    size: "2.7B parameters"
  },
  {
    value: "openchat-3.5",
    label: "OpenChat 3.5",
    description: "Optimized for chat interactions",
    size: "7B parameters"
  }
];

// Add the Logo component
const Logo = () => (
  <svg width="30" height="30" viewBox="0 0 202 201" fill="none" xmlns="http://www.w3.org/2000/svg">
    <g filter="url(#filter0_d_171_147)">
      <circle cx="101.067" cy="101.227" r="32.1546" fill="black"/>
      <circle cx="101.067" cy="101.227" r="31.5012" stroke="#A72D20" strokeWidth="1.30683"/>
    </g>
    <g filter="url(#filter1_d_171_147)">
      <ellipse cx="101.782" cy="101.42" rx="29.7391" ry="30.2609" fill="black"/>
    </g>
    <defs>
      <filter id="filter0_d_171_147" x="0.772979" y="0.061912" width="200.587" height="200.588" filterUnits="userSpaceOnUse" colorInterpolationFilters="sRGB">
        <feFlood floodOpacity="0" result="BackgroundImageFix"/>
        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <feMorphology radius="11.4783" operator="dilate" in="SourceAlpha" result="effect1_dropShadow_171_147"/>
        <feOffset dy="-0.871223"/>
        <feGaussianBlur stdDeviation="28.3304"/>
        <feComposite in2="hardAlpha" operator="out"/>
        <feColorMatrix type="matrix" values="0 0 0 0 1 0 0 0 0 0.670326 0 0 0 0 0.159863 0 0 0 1 0"/>
        <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_171_147"/>
        <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_171_147" result="shape"/>
      </filter>
      <filter id="filter1_d_171_147" x="52.8761" y="51.9923" width="97.8123" height="98.8553" filterUnits="userSpaceOnUse" colorInterpolationFilters="sRGB">
        <feFlood floodOpacity="0" result="BackgroundImageFix"/>
        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <feOffset/>
        <feGaussianBlur stdDeviation="9.58345"/>
        <feComposite in2="hardAlpha" operator="out"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0"/>
        <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_171_147"/>
        <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_171_147" result="shape"/>
      </filter>
    </defs>
  </svg>
)

const copyToClipboard = (text) => {
  navigator.clipboard.writeText(text).then(() => {
    alert('Address copied to clipboard!');
  }, (err) => {
    console.error('Could not copy text: ', err);
  });
};

// Define theme colors to match the popup style
const theme = {
  dark: {
    background: "#2A2A2A",       // Main background
    foreground: "#FFFFFF",      // Text color
    sidebar: "#2A2A2A",         // Sidebar background
    sidebarActive: "#2D2D2D",   // Active sidebar item
    content: "#2A2A2A",         // Content area background
    border: "#3A3A3A",          // Border color
    primary: "#0078D4",         // Primary button color
    destructive: "#E74C3C",     // Destructive button color (delete)
    divider: "#9d9d9d",         // Divider line color
    button: {
      default: "#444444",       // Default button background
      text: "#FFFFFF"           // Button text color
    },
    toggle: {
      active: "#2DCA6E",        // Active toggle switch
      inactive: "#6B6B6B",      // Inactive toggle
      track: "#333333"          // Toggle track
    },
    card: "#333333"            // Card background color
  }
}

// Common styling
const flexCenter = css`
  display: flex;
  align-items: center;
  justify-content: center;
`

const flexBetween = css`
  display: flex;
  align-items: center;
  justify-content: space-between;
`

// Main container
const OptionsContainer = styled.div`
  width: 100%;
  min-height: 100vh;
  background: ${theme.dark.background};
  color: ${theme.dark.foreground};
  position: relative;
  display: flex;
  flex-direction: column;
`

// Header
const Header = styled.header`
  ${flexBetween};
  padding: 14px 20px;
  background: #232323;
  border-bottom: 1px solid ${theme.dark.border};
  height: 80px;
`

const HeaderTitle = styled.h1`
  font-size: 1.4rem; 
  font-weight: 600; 
  color: ${theme.dark.foreground};
  margin: 0; 
  display: flex;
  align-items: center;
`;

const HeaderLogoWrapper = styled.div`
  display: flex;
  align-items: center;
`;

const VersionBadgeContainer = styled.div`
  display: flex;
  align-items: center;
  gap: 10px;
  margin-right: 12px;
`;

const BetaBadge = styled.span`
  position: relative;
  background: linear-gradient(135deg, rgb(56 56 56) 0%, rgb(33 33 33) 100%);
  color: white;
  font-size: 0.65rem;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 4px;
  letter-spacing: 0.7px;
  text-transform: uppercase;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
  &:after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 4px;
    padding: 1px;
    background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.1));
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
  }
`;

const VersionNumber = styled.span`
  color: rgba(255, 255, 255, 0.75);
  font-size: 0.7rem;
  font-weight: 500;
  letter-spacing: 0.5px;
  background: rgba(0, 0, 0, 0.2);
  padding: 3px 8px;
  border-radius: 7px;
  border: 1px solid rgba(255, 255, 255, 0.1);
`;

const LogoImage = styled.img`
  height: 3.5rem;
  width: 3.5rem;
  margin-right: 0.5rem;
  border-radius: 9px;
`;

// Main content area
const ContentWrapper = styled.div`
  display: flex;
  flex: 1;
  overflow: hidden;
`

// Sidebar
const Sidebar = styled.nav`
  width: 240px;
  background: ${theme.dark.sidebar};
  padding: 20px 15px;
  flex-shrink: 0;
  height: calc(100vh - 80px);
  overflow-y: auto;
  border-right: 1px solid ${theme.dark.border};
`

const SidebarItem = styled.button<{ active: boolean }>`
  display: flex;
  align-items: center;
  width: 100%;
  padding: 12px 16px;
  background: ${props => props.active ? theme.dark.sidebarActive : 'transparent'};
  border: none;
  color: ${props => props.active ? theme.dark.foreground : 'rgba(255, 255, 255, 0.7)'};
  font-size: 15px;
  text-align: left;
  cursor: pointer;
  border-radius: 7px;
  margin-bottom: 5px;
  
  &:hover {
    background: ${props => props.active ? theme.dark.sidebarActive : 'rgba(255, 255, 255, 0.05)'};
    color: ${theme.dark.foreground};
  }
`

const SidebarIcon = styled.div`
  width: 18px;
  height: 18px;
  margin-right: 10px;
  opacity: 0.9;
  ${flexCenter};
`

// Content area
const MainContent = styled.div`
  flex: 1;
  padding: 30px;
  overflow-y: auto;
  height: calc(100vh - 80px);
`

const SectionTitle = styled.h2`
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 20px;
  color: ${theme.dark.foreground};
`

const SettingsSection = styled.div`
  margin-bottom: 30px;
`

// Cards
const Card = styled.div`
  background: ${theme.dark.card};
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
`

const CardHeader = styled.div`
  ${flexBetween};
  margin-bottom: 16px;
`

const CardTitle = styled.h3`
  font-size: 1rem;
  font-weight: 600;
  margin: 0;
  color: ${theme.dark.foreground};
  display: flex;
  align-items: center;
  gap: 8px;
`

// Form elements
const FormGroup = styled.div`
  margin-bottom: 16px;
`

const Label = styled.label`
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 6px;
  color: ${theme.dark.foreground};
`

const Input = styled.input`
  width: 100%;
  padding: 10px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid ${theme.dark.border};
  border-radius: 6px;
  color: ${theme.dark.foreground};
  font-size: 0.875rem;
  transition: border-color 0.2s;
  
  &:focus {
    outline: none;
    border-color: ${theme.dark.primary};
  }
`

const Select = styled.select`
  width: 100%;
  padding: 10px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid ${theme.dark.border};
  border-radius: 6px;
  color: ${theme.dark.foreground};
  font-size: 0.875rem;
  transition: border-color 0.2s;
  
  &:focus {
    outline: none;
    border-color: ${theme.dark.primary};
  }
  
  option {
    background: ${theme.dark.background};
  }
`

const Button = styled.button<{ variant?: 'primary' | 'destructive' | 'default' }>`
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  border: none;
  
  background-color: ${props => {
    switch(props.variant) {
      case 'primary': return theme.dark.primary;
      case 'destructive': return theme.dark.destructive;
      default: return theme.dark.button.default;
    }
  }};
  
  color: ${theme.dark.button.text};
  
  &:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  
  &:active {
    transform: translateY(0);
  }
  
  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
`

// Toggle switch
const ToggleWrapper = styled.div`
  ${flexBetween};
  margin-bottom: 12px;
  padding: 8px 0;
`

const ToggleLabel = styled.div`
  display: flex;
  flex-direction: column;
`

const ToggleLabelText = styled.span`
  font-size: 0.875rem;
  font-weight: 500;
  color: ${theme.dark.foreground};
`

const ToggleDescription = styled.span`
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.6);
  margin-top: 2px;
`

const ToggleSwitch = styled.div`
  display: flex;
  align-items: center;
  gap: 8px;
`

const ToggleStatus = styled.span<{ active: boolean }>`
  font-size: 0.75rem;
  font-weight: 600;
  color: ${props => props.active ? theme.dark.toggle.active : 'rgba(255, 255, 255, 0.5)'};
`

const ToggleControl = styled.label`
  position: relative;
  display: inline-block;
  width: 40px;
  height: 22px;
  cursor: pointer;
`

const ToggleInput = styled.input`
  opacity: 0;
  width: 0;
  height: 0;
  
  &:checked + span {
    background-color: ${theme.dark.toggle.active};
  }
  
  &:checked + span:before {
    transform: translateX(18px);
  }
`

const ToggleSlider = styled.span`
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: ${theme.dark.toggle.track};
  border-radius: 34px;
  transition: 0.4s;
  
  &:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    border-radius: 50%;
    transition: 0.4s;
  }
`

// Radio and checkbox styles
const OptionsList = styled.div`
  display: flex;
  flex-direction: column;
  gap: 10px;
`

const OptionItem = styled.label`
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  padding: 8px;
  border-radius: 6px;
  transition: background-color 0.2s;
  
  &:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }
`

const OptionInfo = styled.div`
  display: flex;
  flex-direction: column;
`

const OptionTitle = styled.span`
  font-size: 0.875rem;
  font-weight: 500;
  color: ${theme.dark.foreground};
`

const OptionDescription = styled.span`
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.6);
  margin-top: 2px;
`

const RadioControl = styled.input`
  appearance: none;
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255, 255, 255, 0.5);
  border-radius: 50%;
  outline: none;
  transition: border-color 0.2s;
  position: relative;
  
  &:checked {
    border-color: ${theme.dark.primary};
    
    &:after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: ${theme.dark.primary};
    }
  }
`

const CheckboxControl = styled.input`
  appearance: none;
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255, 255, 255, 0.5);
  border-radius: 4px;
  outline: none;
  transition: border-color 0.2s, background-color 0.2s;
  position: relative;
  
  &:checked {
    border-color: ${theme.dark.primary};
    background-color: ${theme.dark.primary};
    
    &:after {
      content: '';
      position: absolute;
      top: 2px;
      left: 5px;
      width: 6px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
  }
`

// Grid layouts
const Grid = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
`

// Model option card styles
const ModelCard = styled.div<{ selected: boolean }>`
  background: ${props => props.selected ? 'rgba(45, 202, 110, 0.1)' : 'rgba(255, 255, 255, 0.05)'};
  border: 2px solid ${props => props.selected ? theme.dark.toggle.active : 'transparent'};
  border-radius: 8px;
  padding: 15px;
  cursor: pointer;
  transition: all 0.2s ease;
  
  &:hover {
    background: ${props => props.selected ? 'rgba(45, 202, 110, 0.15)' : 'rgba(255, 255, 255, 0.08)'};
  }
`

const ModelName = styled.div`
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 4px;
`

const ModelDescription = styled.div`
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: 8px;
`

const ModelMeta = styled.div`
  font-size: 0.7rem;
  color: rgba(255, 255, 255, 0.5);
  margin-top: 4px;
`

// Badge styled component is already defined below

// Custom-styled tooltips
const TooltipWrapper = styled.div`
  position: relative;
  display: inline-flex;
`

const TooltipContent = styled.div`
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 0.75rem;
  white-space: nowrap;
  z-index: 100;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  
  ${TooltipWrapper}:hover & {
    opacity: 1;
  }
  
  &:after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.85) transparent transparent transparent;
  }
`

// Animation variants for transitions
const popupVariants = {
  hidden: { opacity: 0, scale: 0.8, filter: 'blur(10px)' },
  visible: { opacity: 1, scale: 1, filter: 'blur(0px)' },
  exit: { opacity: 0, scale: 0.8, filter: 'blur(10px)' }
};

// Fade animation variants
const fadeVariants = {
  hidden: { opacity: 0 },
  visible: { opacity: 1 },
  exit: { opacity: 0 }
};

// Slide animation variants
const slideVariants = {
  hidden: { x: -20, opacity: 0 },
  visible: { x: 0, opacity: 1 },
  exit: { x: 20, opacity: 0 }
};

// Rate limit display styled components
const RateLimitContainer = styled.div`
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(0, 0, 0, 0.2);
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 16px;
`

const RateLimitText = styled.span`
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.8);
`

const RateLimitCount = styled.span`
  font-weight: 600;
  color: ${theme.dark.primary};
`

const RateLimitRefresh = styled.button`
  background: none;
  border: none;
  color: ${theme.dark.primary};
  cursor: pointer;
  padding: 0;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  
  &:hover {
    text-decoration: underline;
  }
`

// Toggle component using our styled components
const Toggle = ({ id, checked, onChange, label, description = undefined }) => (
  <ToggleWrapper>
    <ToggleLabel>
      <ToggleLabelText>{label}</ToggleLabelText>
      {description && <ToggleDescription>{description}</ToggleDescription>}
    </ToggleLabel>
    <ToggleSwitch>
      <ToggleStatus active={checked}>{checked ? 'ON' : 'OFF'}</ToggleStatus>
      <ToggleControl htmlFor={id}>
        <ToggleInput
          type="checkbox"
          id={id}
          checked={checked}
          onChange={onChange}
          aria-checked={checked}
        />
        <ToggleSlider />
      </ToggleControl>
    </ToggleSwitch>
  </ToggleWrapper>
);

// Add RateLimitDisplay component using our styled components
const RateLimitDisplay = () => {
  const { remainingActions, isLoading, error, refreshRateLimit } = useRateLimit()

  return (
    <RateLimitContainer>
      {error ? (
        <ErrorMessage message={error} />
      ) : (
        <>
          <div>
            <RateLimitText>API Usage: <RateLimitCount>{remainingActions}</RateLimitCount> remaining actions</RateLimitText>
          </div>
          <RateLimitRefresh onClick={refreshRateLimit} disabled={isLoading}>
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M21 12a9 9 0 0 1-9 9c-4.97 0-9-4.03-9-9s4.03-9 9-9h9" />
              <path d="M15 3l-4 4 4 4" />
            </svg>
            Refresh
          </RateLimitRefresh>
        </>
      )}
    </RateLimitContainer>
  )
}

// Settings card components

// Settings card component using our styled components
const SettingsCard = ({ id = undefined, title, icon, children, className = "" }) => {
  return (
    <Card id={id} className={className}>
      <CardHeader>
        <CardTitle>
          {icon && <span style={{ color: theme.dark.toggle.active }}>{icon}</span>}
          {title}
        </CardTitle>
      </CardHeader>
      {children}
    </Card>
  );
};

// Model option card component
const ModelOption = ({ model, selected, onChange, showPrice = false, showSize = false }) => {
  return (
    <ModelCard 
      selected={selected} 
      onClick={() => onChange(model.value)}
    >
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
        <ModelName>{model.label}</ModelName>
        {selected && (
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 0C3.6 0 0 3.6 0 8C0 12.4 3.6 16 8 16C12.4 16 16 12.4 16 8C16 3.6 12.4 0 8 0ZM12 6L7.2 10.8C7.1 10.9 6.9 11 6.8 11C6.7 11 6.5 10.9 6.4 10.8L4 8.4C3.8 8.2 3.8 7.8 4 7.6C4.2 7.4 4.6 7.4 4.8 7.6L6.8 9.6L11.2 5.2C11.4 5 11.8 5 12 5.2C12.2 5.4 12.2 5.8 12 6Z" fill={theme.dark.toggle.active}/>
          </svg>
        )}
      </div>
      <ModelDescription>{model.description}</ModelDescription>
      {showPrice && model.price && (
        <ModelMeta>Price: {model.price}</ModelMeta>
      )}
      {showSize && model.size && (
        <ModelMeta>Size: {model.size}</ModelMeta>
      )}
    </ModelCard>
  );
};

function IndexOptions() {
  const { settings, setSettings, isConfigured } = useSettings();
  const { remainingActions, isLoading, error: rateLimitError, refreshRateLimit } = useRateLimit();

  // State for UI navigation
  const [activeTab, setActiveTab] = useState('general');
  
  // States from original component
  const storage = useRef(new Storage()).current;
  const [settingsLoaded, setSettingsLoaded] = useState(false);
  const [showSystemPrompt, setShowSystemPrompt] = useState(false);
  const [customSystemPrompt, setCustomSystemPrompt] = useState("");
  const [customUserPrompt, setCustomUserPrompt] = useState("");
  const [selectedPreset, setSelectedPreset] = useState("default");
  const [selectedModel, setSelectedModel] = useState<ModelType>("gemini");
  const [selectedGeminiModel, setSelectedGeminiModel] = useState<GeminiModel>("gemini-1.5-pro");
  const [selectedGrokModel, setSelectedGrokModel] = useState<GrokModel>("grok-2");
  const [selectedLocalModel, setSelectedLocalModel] = useState<LocalModel>("llama-2-70b-chat");
  const [apiKeyInput, setApiKeyInput] = useState("");
  const [apiKeyInputVisible, setApiKeyInputVisible] = useState(false);
  const [serverUrlInput, setServerUrlInput] = useState("");
  const [defaultMode, setDefaultMode] = useState<Mode>("explain");
  const [error, setError] = useState<string | null>(null);
  const [showApiKeyInputError, setShowApiKeyInputError] = useState(false);
  const [showServerUrlInputError, setShowServerUrlInputError] = useState(false);
  const [showApiKeySection, setShowApiKeySection] = useState(false);
  const [expandedSection, setExpandedSection] = useState<string | null>(null);
  const [customizationExpanded, setCustomizationExpanded] = useState(false);

  // Load settings
  useEffect(() => {
    const loadSettings = async () => {
      try {
        const savedSettings = await storage.get("settings") as Settings | undefined;
        if (savedSettings) {
          setSettings({
            ...savedSettings,
            customization: {
              showSelectedText: savedSettings.customization?.showSelectedText ?? true,
              theme: savedSettings.customization?.theme ?? "light",
              radicallyFocus: savedSettings.customization?.radicallyFocus ?? false,
              fontSize: savedSettings.customization?.fontSize ?? "1rem",
              highlightColor: savedSettings.customization?.highlightColor ?? "default",
              popupAnimation: savedSettings.customization?.popupAnimation ?? "scale",
              persistHighlight: savedSettings.customization?.persistHighlight ?? false,
              layoutMode: savedSettings.customization?.layoutMode ?? "sidebar",
              contextAwareness: savedSettings.customization?.contextAwareness ?? false,
              activationMode: savedSettings.customization?.activationMode ?? "manual",
              enablePDFSupport: savedSettings.customization?.enablePDFSupport ?? false
            }
          });
        }
      } catch (err) {
        console.error("Error loading settings:", err);
        setError("Failed to load settings");
      }
    };
    
    loadSettings();
  }, []);

  // Add effect to scroll to the prompt-templates section if the URL has that hash
  useEffect(() => {
    // Function to scroll to the element with the given ID
    const scrollToElement = (id: string) => {
      // Add a small delay to ensure the DOM is fully loaded
      setTimeout(() => {
        const element = document.getElementById(id);
        if (element) {
          // Scroll to the element with smooth behavior
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 300);
    };

    // Check if the URL has a hash
    if (window.location.hash) {
      // Remove the # character
      const id = window.location.hash.substring(1);
      scrollToElement(id);
    }

    // Add event listener for hash changes
    const handleHashChange = () => {
      if (window.location.hash) {
        const id = window.location.hash.substring(1);
        scrollToElement(id);
      }
    };

    window.addEventListener('hashchange', handleHashChange);

    // Clean up the event listener
    return () => {
      window.removeEventListener('hashchange', handleHashChange);
    };
  }, []);

  // Update the handleSave function to include the customPrompts
  const handleSave = async () => {
    try {
      setIsSaving(true);
      const updatedSettings = {
        ...settings,
        // Include any fields you need to save
        modelType: settings.modelType,
        apiKey: settings.apiKey,
        geminiApiKey: settings.geminiApiKey,
        xaiApiKey: settings.xaiApiKey,
        serverUrl: settings.serverUrl,
        geminiModel: settings.geminiModel,
        grokModel: settings.grokModel,
        localModel: settings.localModel,
        maxTokens: settings.maxTokens,
        preferredModes: settings.preferredModes,
        customPrompts: settings.customPrompts, // Save custom prompts
        customization: settings.customization
      };
      
      // Save updated settings to storage
      await storage.set("settings", updatedSettings);
      
      // Notify tabs about settings update
      chrome.tabs.query({}, (tabs) => {
        tabs.forEach(tab => {
          if (tab.id) {
            chrome.tabs.sendMessage(tab.id, { 
              type: "SETTINGS_UPDATED", 
              settings: updatedSettings 
            }).catch(err => {
              // Ignore errors for tabs that don't have the content script running
              console.log(`Could not send message to tab ${tab.id}:`, err);
            });
          }
        });
      });
      
      setIsSaving(false);
      setSaveSuccess(true);
      
      // Show success message briefly
      setTimeout(() => {
        setSaveSuccess(false);
      }, 3000);
    } catch (err) {
      console.error("Failed to save settings:", err);
      setError("Failed to save settings");
      setIsSaving(false);
    }
  };

  // Add a helper function to set server URL
  const handleServerUrlChange = (e) => {
    let url = e.target.value;
    // Ensure the URL starts with http://127.0.0.1:
    if (url && !url.startsWith("http://")) {
      url = `http://${url}`;
    }
    setSettings(prev => ({
      ...prev,
      serverUrl: url
    }));
  };


  const colorOptions = [
    { value: 'default', label: 'Default (System)', color: 'lu-bg-[#fff8bc]' },
    { value: 'orange', label: 'Orange', color: 'lu-bg-[#FFBF5A]' },
    { value: 'blue', label: 'Blue', color: 'lu-bg-[#93C5FD]' },
    { value: 'green', label: 'Green', color: 'lu-bg-[#86EFAC]' },
    { value: 'purple', label: 'Purple', color: 'lu-bg-[#C4B5FD]' },
    { value: 'pink', label: 'Pink', color: 'lu-bg-[#FDA4AF]' }
  ];

  // Add a new function to handle immediate settings updates
  const handleImmediateSettingUpdate = async (key: string, value: any) => {
    try {
      const newSettings = {
        ...settings,
        customization: {
          ...settings.customization,
          [key]: value
        }
      };
      
      setSettings(newSettings);
      await storage.set("settings", newSettings);
   
    } catch (error) {
    
      setError(`Failed to update ${key}`);
    }
  };

  // Add event listener for success messages
  useEffect(() => {
    const handleSettingUpdated = (event: CustomEvent) => {
      const toast = document.getElementById('toast');
      if (toast) {
        toast.textContent = event.detail.message;
        toast.style.opacity = '1';
        setTimeout(() => {
          toast.style.opacity = '0';
        }, 2000);
      }
    };

    window.addEventListener('settingUpdated', handleSettingUpdated as EventListener);
    return () => {
      window.removeEventListener('settingUpdated', handleSettingUpdated as EventListener);
    };
  }, []);

  // Add a function to get the current prompt for a mode
  const getCurrentPrompts = (mode: Mode) => {
    const defaultSystemPrompt = SYSTEM_PROMPTS[mode] || "";
    const defaultUserPrompt = typeof USER_PROMPTS[mode] === 'function' 
      ? mode === 'explain' ? 'What does this mean: ${text}'
        : mode === 'summarize' ? 'Key points from: ${text}'
        : mode === 'analyze' ? 'Analyze this: ${text}'
        : mode === 'translate' ? 'Translate from ${fromLanguage} to ${toLanguage}:\n${text}'
        : '${text}'
      : USER_PROMPTS[mode] || "";

    const systemPrompt = settings.customPrompts?.systemPrompts[mode] || defaultSystemPrompt;
    const userPrompt = settings.customPrompts?.userPrompts[mode] || defaultUserPrompt;
    
    return { systemPrompt, userPrompt, defaultSystemPrompt, defaultUserPrompt };
  };

  // Function to handle editing a prompt
  const handleEditPrompt = (mode: Mode, type: 'system' | 'user') => {
    setActivePromptMode(mode);
    const { systemPrompt, userPrompt } = getCurrentPrompts(mode);
    
    if (type === 'system') {
      setEditedSystemPrompt(systemPrompt);
      setIsEditingSystemPrompt(true);
      setIsEditingUserPrompt(false);
    } else {
      setEditedUserPrompt(userPrompt);
      setIsEditingUserPrompt(true);
      setIsEditingSystemPrompt(false);
    }
  };

  // Function to save edited prompt
  const saveEditedPrompt = (type: 'system' | 'user') => {
    const currentCustomPrompts = settings.customPrompts || {
      systemPrompts: {},
      userPrompts: {}
    };
    
    let updatedCustomPrompts;
    
    if (type === 'system') {
      updatedCustomPrompts = {
        ...currentCustomPrompts,
        systemPrompts: {
          ...currentCustomPrompts.systemPrompts,
          [activePromptMode]: editedSystemPrompt
        }
      };
      setIsEditingSystemPrompt(false);
    } else {
      updatedCustomPrompts = {
        ...currentCustomPrompts,
        userPrompts: {
          ...currentCustomPrompts.userPrompts,
          [activePromptMode]: editedUserPrompt
        }
      };
      setIsEditingUserPrompt(false);
    }
    
    setSettings(prev => ({
      ...prev,
      customPrompts: updatedCustomPrompts
    }));
  };

  // Function to reset prompt to default
  const resetPromptToDefault = (mode: Mode, type: 'system' | 'user') => {
    const { defaultSystemPrompt, defaultUserPrompt } = getCurrentPrompts(mode);
    const currentCustomPrompts = settings.customPrompts || {
      systemPrompts: {},
      userPrompts: {}
    };
    
    let updatedCustomPrompts;
    
    if (type === 'system') {
      // Create a new object without the specified mode
      const { [mode]: _, ...restSystemPrompts } = currentCustomPrompts.systemPrompts;
      updatedCustomPrompts = {
        ...currentCustomPrompts,
        systemPrompts: restSystemPrompts
      };
      
      // Update the edited text if we're currently editing
      if (isEditingSystemPrompt && activePromptMode === mode) {
        setEditedSystemPrompt(defaultSystemPrompt);
      }
    } else {
      // Create a new object without the specified mode
      const { [mode]: _, ...restUserPrompts } = currentCustomPrompts.userPrompts;
      updatedCustomPrompts = {
        ...currentCustomPrompts,
        userPrompts: restUserPrompts
      };
      
      // Update the edited text if we're currently editing
      if (isEditingUserPrompt && activePromptMode === mode) {
        setEditedUserPrompt(defaultUserPrompt);
      }
    }
    
    setSettings(prev => ({
      ...prev,
      customPrompts: updatedCustomPrompts
    }));
  };

  return (
    <div className="lu-min-h-screen lu-bg-white">
      <div className="lu-max-w-[800px] lu-mx-auto lu-p-4">
        {/* Header */}
        <motion.div 
          initial={{ opacity: 0, y: -10 }}
          animate={{ opacity: 1, y: 0 }}
          className="lu-flex lu-items-center lu-justify-between lu-mb-6 lu-py-4"
        >
          <div className="lu-flex lu-items-center lu-gap-2">
            <Logo />
            <div>
              <h1 className="lu-text-lg lu-font-medium lu-text-gray-800 lu-m-0">
                LightUp Settings
              </h1>
              <p className="lu-text-xs lu-text-gray-500 lu-mt-1">
                Configure your AI assistant preferences
              </p>
            </div>
          </div>
          <Badge variant="success">v0.1.12</Badge>
        </motion.div>

        <div className="lu-grid lu-gap-6">
          {/* Model Configuration */}
          <SettingsCard 
            title="Model Configuration" 
            icon={
              <svg xmlns="http://www.w3.org/2000/svg" className="lu-h-6 lu-w-6 lu-text-[#10a37f]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            }
          >
            <div className="lu-space-y-6">
              <div>
                <label className="lu-block lu-mb-2 lu-text-gray-800 lu-font-medium lu-text-base">
                  Model Type
                </label>
                <select 
                  value={settings.modelType}
                  onChange={(e) => setSettings(prev => ({
                    ...prev,
                    modelType: e.target.value as ModelType
                  }))}
                  className="lu-w-full lu-p-3 lu-rounded-lg lu-border lu-border-gray-200 lu-bg-white lu-text-gray-800 lu-font-medium lu-transition-colors lu-duration-200 hover:lu-border-[#10a37f] focus:lu-border-[#10a37f] focus:lu-ring focus:lu-ring-[#10a37f]/20"
                >
                  <option value="basic">LightUp Basic (Free)</option>
                  <option value="local">Local LLM</option>
                  <option value="gemini">Google Gemini</option>
                  <option value="xai">xAI (Grok)</option>
                </select>
              </div>

              {settings.modelType === "basic" && (
                <motion.div
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: "auto" }}
                  exit={{ opacity: 0, height: 0 }}
                  className="lu-bg-gradient-to-br from-[#10a37f]/5 to-[#10a37f]/10 lu-p-6 lu-rounded-xl lu-border lu-border-[#10a37f]/20"
                >
                  <div className="lu-flex lu-items-center lu-gap-3 lu-mb-4">
                    <div className="lu-p-2 lu-bg-[#10a37f] lu-rounded-lg">
                      <svg xmlns="http://www.w3.org/2000/svg" className="lu-h-5 lu-w-5 lu-text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                      </svg>
                    </div>
                    <div>
                      <h3 className="lu-text-lg lu-font-semibold lu-text-gray-900">LightUp Basic</h3>
                      <p className="lu-text-sm lu-text-gray-600">Free tier with basic features</p>
                    </div>
                  </div>

                  <div className="lu-space-y-3">
                    <div className="lu-flex lu-items-center lu-gap-2 lu-text-sm lu-text-gray-600">
                      <svg className="lu-w-5 lu-h-5 lu-text-[#10a37f]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <span>20 requests per day</span>
                    </div>
                    <div className="lu-flex lu-items-center lu-gap-2 lu-text-sm lu-text-gray-600">
                      <svg className="lu-w-5 lu-h-5 lu-text-[#10a37f]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                      </svg>
                      <span>Powered by Gemini 2.0</span>
                    </div>
                    <div className="lu-flex lu-items-center lu-gap-2 lu-text-sm lu-text-gray-600">
                      <svg className="lu-w-5 lu-h-5 lu-text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                      <span>Not for sensitive data</span>
                    </div>
                  </div>

                  <RateLimitDisplay />
                </motion.div>
              )}

              {settings.modelType === "local" && (
                <motion.div
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: "auto" }}
                  exit={{ opacity: 0, height: 0 }}
                  className="lu-space-y-6"
                >
                  <div>
                    <label className="lu-block lu-mb-2 lu-text-sm lu-font-medium lu-text-gray-700">
                      Llama Server URL
                    </label>
                    <input
                      type="text"
                      value={settings.serverUrl}
                      onChange={handleServerUrlChange}
                      className="lu-w-full lu-p-2.5 lu-rounded-md lu-border lu-border-gray-300 lu-text-gray-700 lu-text-sm lu-transition-colors focus:lu-outline-none focus:lu-ring-2 focus:lu-ring-[#10a37f]/20 focus:lu-border-[#10a37f]"
                      placeholder="http://127.0.0.1:1234"
                    />
                    <p className="lu-mt-1.5 lu-text-xs lu-text-gray-500">
                      Local LLM server setup. No API key required.
                    </p>
                  </div>

                  <div>
                    <label className="lu-block lu-mb-4 lu-text-gray-800 lu-font-medium lu-text-base">
                      Local Model
                    </label>
                    <div className="lu-grid lu-gap-3">
                      {LOCAL_MODELS.map((model) => (
                        <ModelOption
                          key={model.value}
                          model={model}
                          selected={settings.localModel === model.value}
                          onChange={() => setSettings(prev => ({ ...prev, localModel: model.value }))}
                          showSize
                        />
                      ))}
                    </div>
                  </div>
                </motion.div>
              )}

              {settings.modelType === "gemini" && (
                <motion.div
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: "auto" }}
                  exit={{ opacity: 0, height: 0 }}
                  className="lu-space-y-6"
                >
                  <div>
                    <label className="lu-block lu-mb-2 lu-text-sm lu-font-medium lu-text-gray-700">
                      Google Gemini API Key
                    </label>
                    <div className="lu-relative">
                      <input
                        type="password"
                        value={settings.geminiApiKey}
                        onChange={(e) => setSettings(prev => ({
                          ...prev,
                          geminiApiKey: e.target.value
                        }))}
                        className="lu-w-full lu-p-2.5 lu-rounded-md lu-border lu-border-gray-300 lu-text-gray-700 lu-text-sm lu-transition-colors focus:lu-outline-none focus:lu-ring-2 focus:lu-ring-[#10a37f]/20 focus:lu-border-[#10a37f]"
                        placeholder="Enter your Gemini API key"
                      />
                    </div>
                    <div className="lu-mt-2 lu-flex lu-items-center lu-gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" className="lu-h-4 lu-w-4 lu-text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                      </svg>
                      <p className="lu-text-sm lu-text-gray-500">
                        Get your API key from the <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="lu-text-blue-500 hover:lu-underline">Google AI Studio</a>
                      </p>
                    </div>
                  </div>

                  <div>
                    <label className="lu-block lu-mb-4 lu-text-gray-800 lu-font-medium lu-text-base">
                      Gemini Model
                    </label>
                    <div className="lu-grid lu-gap-3">
                      {GEMINI_MODELS.map((model) => (
                        <ModelOption
                          key={model.value}
                          model={model}
                          selected={settings.geminiModel === model.value}
                          onChange={() => setSettings(prev => ({ ...prev, geminiModel: model.value }))}
                        />
                      ))}
                    </div>
                  </div>

                  <div className="lu-p-4 lu-bg-blue-50 lu-rounded-lg">
                    <div className="lu-flex lu-items-start lu-gap-3">
                      <svg xmlns="http://www.w3.org/2000/svg" className="lu-h-5 lu-w-5 lu-text-blue-500 lu-mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                      </svg>
                      <div>
                        <h4 className="lu-text-sm lu-font-medium lu-text-blue-900">Free Tier Available</h4>
                        <p className="lu-text-sm lu-text-blue-700 lu-mt-0.5">
                          Google Gemini offers a generous free tier with up to 60 requests per minute.
                        </p>
                      </div>
                    </div>
                  </div>
                </motion.div>
              )}

              {settings.modelType === "xai" && (
                <motion.div
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: "auto" }}
                  exit={{ opacity: 0, height: 0 }}
                  className="lu-space-y-6"
                >
                  <div>
                    <label className="lu-block lu-mb-2 lu-text-gray-800 lu-font-medium lu-text-base">
                      xAI API Key
                    </label>
                    <div className="lu-relative">
                      <input
                        type="password"
                        value={settings.xaiApiKey}
                        onChange={(e) => setSettings(prev => ({
                          ...prev,
                          xaiApiKey: e.target.value
                        }))}
                        className="lu-w-full lu-p-3 lu-rounded-lg lu-border lu-border-gray-200 lu-bg-white lu-text-gray-800 lu-font-medium lu-transition-colors lu-duration-200 hover:lu-border-[#10a37f] focus:lu-border-[#10a37f] focus:lu-ring focus:lu-ring-[#10a37f]/20"
                        placeholder="Enter your xAI API key"
                      />
                    </div>
                    <div className="lu-mt-2 lu-flex lu-items-center lu-gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" className="lu-h-4 lu-w-4 lu-text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                      </svg>
                      <p className="lu-text-sm lu-text-gray-500">
                        Get your API key from the <a href="https://x.ai/api" target="_blank" rel="noopener noreferrer" className="lu-text-blue-500 hover:lu-underline">xAI platform</a>
                      </p>
                    </div>
                  </div>

                  <div>
                    <label className="lu-block lu-mb-4 lu-text-gray-800 lu-font-medium lu-text-base">
                      Grok Model
                    </label>
                    <div className="lu-grid lu-gap-3">
                      {GROK_MODELS.map((model) => (
                        <ModelOption
                          key={model.value}
                          model={model}
                          selected={settings.grokModel === model.value}
                          onChange={() => setSettings(prev => ({ ...prev, grokModel: model.value }))}
                          showPrice
                        />
                      ))}
                    </div>
                  </div>

                  <div className="lu-p-4 lu-bg-blue-50 lu-rounded-lg">
                    <div className="lu-flex lu-items-start lu-gap-3">
                      <svg xmlns="http://www.w3.org/2000/svg" className="lu-h-5 lu-w-5 lu-text-blue-500 lu-mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                      </svg>
                      <div>
                        <h4 className="lu-text-sm lu-font-medium lu-text-blue-900">Beta Access</h4>
                        <p className="lu-text-sm lu-text-blue-700 lu-mt-0.5">
                          xAI offers $25 in free credits for beta users. Sign up on their platform to get started.
                        </p>
                      </div>
                    </div>
                  </div>
                </motion.div>
              )}

              {/* Max Tokens Input */}
              <div>
                <label className="lu-block lu-mb-2 lu-text-gray-800 lu-font-medium lu-text-base">
                  Max Tokens
                </label>
                <input
                  type="number"
                  value={settings.maxTokens}
                  onChange={(e) => setSettings(prev => ({
                    ...prev,
                    maxTokens: parseInt(e.target.value) || 1000
                  }))}
                  className="lu-w-full lu-p-3 lu-rounded-lg lu-border lu-border-gray-200 lu-bg-white lu-text-gray-800 lu-font-medium lu-transition-colors lu-duration-200 hover:lu-border-[#10a37f] focus:lu-border-[#10a37f] focus:lu-ring focus:lu-ring-[#10a37f]/20"
                  placeholder="1000"
                  min="1"
                  max="4096"
                />
                <p className="lu-mt-2 lu-text-sm lu-text-gray-500">
                  Maximum number of tokens to generate in each response
                </p>
              </div>

            </div>
          </SettingsCard>

          {/* Customization */}
          <SettingsCard 
            title="Customization" 
            icon={
              <svg xmlns="http://www.w3.org/2000/svg" className="lu-h-6 lu-w-6 lu-text-[#10a37f]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
              </svg>
            }
          >
            <div className="lu-grid lu-gap-6">
              {/* Layout Mode Selection */}
              <div className="lu-space-y-2">
                <label className="lu-block lu-text-gray-800 lu-font-medium lu-text-base">Layout Mode</label>
                <div className="lu-flex lu-flex-col lu-space-y-6">
                  <h3 className="lu-text-xl lu-font-medium lu-text-center">Choose your layout</h3>
                  
                  <div className="lu-grid lu-grid-cols-3 lu-gap-4">
                    {/* Floating Layout Option */}
                    <button
                      onClick={() => handleImmediateSettingUpdate('layoutMode', 'floating')}
                      className={`lu-p-4 lu-rounded-xl lu-border ${
                        settings.customization?.layoutMode === 'floating'
                          ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                          : 'lu-border-gray-200 hover:lu-border-gray-300'
                      } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                    >
                      <div className="lu-bg-gray-100 lu-rounded-lg lu-p-4 lu-mb-3">
                        <div className="lu-relative lu-w-full lu-bg-white lu-aspect-[4/3] lu-rounded-lg lu-border lu-border-gray-200 lu-flex lu-justify-center lu-items-center">
                          {/* Webpage content representation */}
                          <div className="lu-absolute lu-inset-0 lu-m-2">
                            <div className="lu-h-2 lu-w-3/4 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                            <div className="lu-h-1 lu-w-full lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                            <div className="lu-h-1 lu-w-5/6 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                          </div>
                          {/* Floating popup representation */}
                          <div className="lu-absolute lu-w-1/2 lu-h-1/2 lu-bg-white lu-rounded-md lu-border lu-border-gray-300 lu-shadow-md lu-right-3 lu-top-6 lu-z-10">
                            <div className="lu-h-3 lu-border-b lu-border-gray-200"></div>
                            <div className="lu-px-1 lu-py-1">
                              <div className="lu-h-1 lu-w-3/4 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                              <div className="lu-h-1 lu-w-1/2 lu-bg-gray-200 lu-rounded"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <span className="lu-block lu-text-center lu-font-medium">Floating</span>
                    </button>

                    {/* Sidebar Layout Option */}
                    <button
                      onClick={() => handleImmediateSettingUpdate('layoutMode', 'sidebar')}
                      className={`lu-p-4 lu-rounded-xl lu-border ${
                        settings.customization?.layoutMode === 'sidebar'
                          ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                          : 'lu-border-gray-200 hover:lu-border-gray-300'
                      } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                    >
                      <div className="lu-bg-gray-100 lu-rounded-lg lu-p-4 lu-mb-3">
                        <div className="lu-relative lu-w-full lu-bg-white lu-aspect-[4/3] lu-rounded-lg lu-border lu-border-gray-200 lu-flex">
                          {/* Webpage content representation */}
                          <div className="lu-w-2/3 lu-p-2">
                            <div className="lu-h-2 lu-w-3/4 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                            <div className="lu-h-1 lu-w-full lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                            <div className="lu-h-1 lu-w-5/6 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                          </div>
                          {/* Sidebar representation */}
                          <div className="lu-w-1/3 lu-border-l lu-border-gray-200 lu-bg-gray-50 lu-rounded-r-lg">
                            <div className="lu-h-3 lu-border-b lu-border-gray-200"></div>
                            <div className="lu-px-1 lu-py-1">
                              <div className="lu-h-1 lu-w-3/4 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                              <div className="lu-h-1 lu-w-1/2 lu-bg-gray-200 lu-rounded"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <span className="lu-block lu-text-center lu-font-medium">Sidebar</span>
                    </button>

                    {/* Centered Layout Option */}
                    <button
                      onClick={() => handleImmediateSettingUpdate('layoutMode', 'centered')}
                      className={`lu-p-4 lu-rounded-xl lu-border ${
                        settings.customization?.layoutMode === 'centered'
                          ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                          : 'lu-border-gray-200 hover:lu-border-gray-300'
                      } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                    >
                      <div className="lu-bg-gray-100 lu-rounded-lg lu-p-4 lu-mb-3">
                        <div className="lu-relative lu-w-full lu-bg-white lu-aspect-[4/3] lu-rounded-lg lu-border lu-border-gray-200 lu-flex lu-justify-center lu-items-center">
                          {/* Background blur representation */}
                          <div className="lu-absolute lu-inset-0 lu-bg-gray-200/20 lu-backdrop-blur-sm"></div>
                          {/* Centered popup representation */}
                          <div className="lu-absolute lu-w-3/4 lu-bg-white lu-rounded-md lu-border lu-border-gray-300 lu-shadow-md lu-z-10">
                            <div className="lu-h-3 lu-border-b lu-border-gray-200"></div>
                            <div className="lu-px-2 lu-py-2">
                              <div className="lu-h-1 lu-w-3/4 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                              <div className="lu-h-1 lu-w-1/2 lu-bg-gray-200 lu-rounded"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <span className="lu-block lu-text-center lu-font-medium">Centered</span>
                    </button>
                  </div>
                </div>
              </div>

              <Switch
                id="show-selected-text"
                checked={settings.customization?.showSelectedText ?? true}
                onChange={(e) => handleImmediateSettingUpdate('showSelectedText', e.target.checked)}
                label="Show Selected Text"
                description="Display the text you've selected in the results"
              />

              <Switch
                id="radical-focus"
                checked={settings.customization?.radicallyFocus ?? false}
                onChange={(e) => handleImmediateSettingUpdate('radicallyFocus', e.target.checked)}
                label="Radical Focus Mode"
                description="Blur background when viewing results"
              />

              <Switch
                id="persistent-highlight"
                checked={settings.customization?.persistHighlight ?? false}
                onChange={(e) => handleImmediateSettingUpdate('persistHighlight', e.target.checked)}
                label="Persistent Highlighting"
                description="Keep text highlighted after selection"
              />

              <Switch
                id="global-action-button"
                checked={settings.customization?.showGlobalActionButton !== false}
                onChange={(e) => handleImmediateSettingUpdate('showGlobalActionButton', e.target.checked)}
                label="Quick View"
                description="Show floating button to instantly process page content"
              />

              <Switch
                id="automatic-activation"
                checked={settings.customization?.activationMode === "automatic"}
                onChange={(e) => handleImmediateSettingUpdate('activationMode', e.target.checked ? "automatic" : "manual")}
                label="Automatic Activation"
                description="Show popup automatically when text is selected (without requiring context menu)"
              />

              <Switch
                id="pdf-support"
                checked={settings.customization?.enablePDFSupport ?? false}
                onChange={(e) => handleImmediateSettingUpdate('enablePDFSupport', e.target.checked)}
                label="PDF Support"
                description="Enable text selection and annotations in PDF files"
              />

              {/* Font Size Selection */}
              <div className="lu-space-y-2">
                <label className="lu-block lu-text-gray-800 lu-font-medium lu-text-base">Font Size</label>
                <div className="lu-flex lu-flex-col lu-space-y-6">
                  <h3 className="lu-text-xl lu-font-medium lu-text-center">Choose font size</h3>
                  
                  <div className="lu-grid lu-grid-cols-3 lu-gap-4">
                    {[
                      { value: '0.8rem', label: 'Small' },
                      { value: '1rem', label: 'Medium' },
                      { value: '1.2rem', label: 'Large' }
                    ].map((size) => (
                      <button
                        key={size.value}
                        onClick={() => handleImmediateSettingUpdate('fontSize', size.value)}
                        className={`lu-p-4 lu-rounded-xl lu-border ${
                          settings.customization?.fontSize === size.value
                            ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                            : 'lu-border-gray-200 hover:lu-border-gray-300'
                        } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                      >
                        <div className="lu-bg-gray-100 lu-rounded-lg lu-p-4 lu-mb-3">
                          <div className="lu-relative lu-w-full lu-bg-white lu-aspect-[4/3] lu-rounded-lg lu-border lu-border-gray-200 lu-p-3 lu-flex lu-flex-col lu-justify-center">
                            <div className="lu-text-center" style={{ fontSize: size.value }}>
                              <p className="lu-text-gray-800 lu-m-0">Sample Text</p>
                              <p className="lu-text-gray-500 lu-m-0 lu-mt-1">The quick brown fox jumps over the lazy dog.</p>
                            </div>
                          </div>
                        </div>
                        <span className="lu-block lu-text-center lu-font-medium">{size.label}</span>
                        <span className="lu-block lu-text-center lu-text-xs lu-text-gray-500">{size.value}</span>
                      </button>
                    ))}
                  </div>
                  
                  <div className="lu-grid lu-grid-cols-3 lu-gap-4">
                    {[
                      { value: '0.9rem', label: 'Small-Medium' },
                      { value: '1.1rem', label: 'Medium-Large' },
                      { value: '1.3rem', label: 'X-Large' }
                    ].map((size) => (
                      <button
                        key={size.value}
                        onClick={() => handleImmediateSettingUpdate('fontSize', size.value)}
                        className={`lu-p-4 lu-rounded-xl lu-border ${
                          settings.customization?.fontSize === size.value
                            ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                            : 'lu-border-gray-200 hover:lu-border-gray-300'
                        } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                      >
                        <div className="lu-bg-gray-100 lu-rounded-lg lu-p-4 lu-mb-3">
                          <div className="lu-relative lu-w-full lu-bg-white lu-aspect-[4/3] lu-rounded-lg lu-border lu-border-gray-200 lu-p-3 lu-flex lu-flex-col lu-justify-center">
                            <div className="lu-text-center" style={{ fontSize: size.value }}>
                              <p className="lu-text-gray-800 lu-m-0">Sample Text</p>
                              <p className="lu-text-gray-500 lu-m-0 lu-mt-1">The quick brown fox.</p>
                            </div>
                          </div>
                        </div>
                        <span className="lu-block lu-text-center lu-font-medium">{size.label}</span>
                        <span className="lu-block lu-text-center lu-text-xs lu-text-gray-500">{size.value}</span>
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {/* Theme Selection */}
              <div className="lu-space-y-2">
                <label className="lu-block lu-text-gray-800 lu-font-medium lu-text-base">Theme</label>
                <div className="lu-flex lu-flex-col lu-space-y-6">
                  <h3 className="lu-text-xl lu-font-medium lu-text-center">Choose your style</h3>
                  
                  <div className="lu-grid lu-grid-cols-2 lu-gap-6">
                    {/* Light Theme Option */}
                    <button
                      onClick={() => handleImmediateSettingUpdate('theme', 'light')}
                      className={`lu-p-4 lu-rounded-xl lu-border ${
                        settings.customization?.theme === 'light'
                          ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                          : 'lu-border-gray-200 hover:lu-border-gray-300'
                      } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                    >
                      <div className="lu-bg-gray-100 lu-rounded-lg lu-p-6 lu-flex lu-items-center lu-justify-center lu-mb-4">
                        <div className="lu-w-full lu-aspect-[4/3] lu-bg-white lu-rounded-lg lu-border lu-border-gray-200 lu-flex lu-flex-col">
                          <div className="lu-h-8 lu-bg-gray-50 lu-border-b lu-border-gray-200 lu-flex lu-items-center lu-px-3">
                            <div className="lu-w-3 lu-h-3 lu-bg-gray-200 lu-rounded-full lu-mr-1"></div>
                            <div className="lu-flex-1 lu-flex lu-items-center lu-justify-center">
                              <span className="lu-text-xs lu-font-medium">Aa</span>
                            </div>
                            <div className="lu-w-8 lu-h-4 lu-bg-gray-300 lu-rounded-full"></div>
                          </div>
                          <div className="lu-flex-1 lu-p-2">
                            <div className="lu-w-full lu-h-2 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                            <div className="lu-flex lu-items-center lu-mb-1">
                              <div className="lu-w-2 lu-h-2 lu-bg-gray-200 lu-rounded-full lu-mr-1"></div>
                              <div className="lu-flex-1 lu-h-2 lu-bg-gray-200 lu-rounded"></div>
                            </div>
                            <div className="lu-flex lu-items-center">
                              <div className="lu-w-2 lu-h-2 lu-bg-gray-200 lu-rounded-full lu-mr-1"></div>
                              <div className="lu-w-3/4 lu-h-2 lu-bg-gray-200 lu-rounded"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <span className="lu-block lu-text-center lu-font-medium">Light</span>
                    </button>

                    {/* Dark Theme Option */}
                    <button
                      onClick={() => handleImmediateSettingUpdate('theme', 'dark')}
                      className={`lu-p-4 lu-rounded-xl lu-border ${
                        settings.customization?.theme === 'dark'
                          ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                          : 'lu-border-gray-200 hover:lu-border-gray-300'
                      } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                    >
                      <div className="lu-bg-gray-900 lu-rounded-lg lu-p-6 lu-flex lu-items-center lu-justify-center lu-mb-4">
                        <div className="lu-w-full lu-aspect-[4/3] lu-bg-gray-800 lu-rounded-lg lu-border lu-border-gray-700 lu-flex lu-flex-col">
                          <div className="lu-h-8 lu-bg-gray-900 lu-border-b lu-border-gray-700 lu-flex lu-items-center lu-px-3">
                            <div className="lu-w-3 lu-h-3 lu-bg-gray-700 lu-rounded-full lu-mr-1"></div>
                            <div className="lu-flex-1 lu-flex lu-items-center lu-justify-center">
                              <span className="lu-text-xs lu-font-medium lu-text-white">Aa</span>
                            </div>
                            <div className="lu-w-8 lu-h-4 lu-bg-gray-600 lu-rounded-full"></div>
                          </div>
                          <div className="lu-flex-1 lu-p-2">
                            <div className="lu-w-full lu-h-2 lu-bg-gray-700 lu-rounded lu-mb-1"></div>
                            <div className="lu-flex lu-items-center lu-mb-1">
                              <div className="lu-w-2 lu-h-2 lu-bg-gray-700 lu-rounded-full lu-mr-1"></div>
                              <div className="lu-flex-1 lu-h-2 lu-bg-gray-700 lu-rounded"></div>
                            </div>
                            <div className="lu-flex lu-items-center">
                              <div className="lu-w-2 lu-h-2 lu-bg-gray-700 lu-rounded-full lu-mr-1"></div>
                              <div className="lu-w-3/4 lu-h-2 lu-bg-gray-700 lu-rounded"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <span className="lu-block lu-text-center lu-font-medium">Dark</span>
                    </button>
                  </div>
                </div>
              </div>

              {/* Color Selection */}
              <div className="lu-space-y-2">
                <label className="lu-block lu-text-gray-800 lu-font-medium lu-text-base">Highlight Color</label>
                <div className="lu-flex lu-flex-col lu-space-y-6">
                  <h3 className="lu-text-xl lu-font-medium lu-text-center">Choose highlight color</h3>
                  
                  <div className="lu-grid lu-grid-cols-3 lu-gap-4">
                    {colorOptions.map((option) => (
                      <button
                        key={option.value}
                        onClick={() => handleImmediateSettingUpdate('highlightColor', option.value)}
                        className={`lu-p-4 lu-rounded-xl lu-border ${
                          settings.customization?.highlightColor === option.value
                            ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                            : 'lu-border-gray-200 hover:lu-border-gray-300'
                        } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                      >
                        <div className="lu-bg-gray-100 lu-rounded-lg lu-p-4 lu-mb-3">
                          <div className="lu-relative lu-w-full lu-bg-white lu-aspect-[4/3] lu-rounded-lg lu-border lu-border-gray-200 lu-p-3">
                            {/* Text content representation */}
                            <div className="lu-h-2 lu-w-full lu-bg-gray-200 lu-rounded lu-mb-2"></div>
                            <div className="lu-h-2 lu-w-5/6 lu-bg-gray-200 lu-rounded lu-mb-2"></div>
                            {/* Highlighted text representation */}
                            <div className={`lu-h-2 lu-w-1/2 ${option.color} lu-rounded lu-mb-2`}></div>
                            <div className="lu-h-2 lu-w-full lu-bg-gray-200 lu-rounded lu-mb-2"></div>
                            <div className="lu-h-2 lu-w-3/4 lu-bg-gray-200 lu-rounded"></div>
                          </div>
                        </div>
                        <div className="lu-flex lu-flex-col lu-items-center lu-gap-1">
                          <div className={`lu-w-6 lu-h-6 lu-rounded-full ${option.color}`}></div>
                          <span className="lu-text-sm lu-font-medium">{option.label}</span>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {/* Popup Animation Selection */}
              <div className="lu-space-y-2">
                <label className="lu-block lu-text-gray-800 lu-font-medium lu-text-base">Popup Animation</label>
                <div className="lu-flex lu-flex-col lu-space-y-6">
                  <h3 className="lu-text-xl lu-font-medium lu-text-center">Choose animation style</h3>
                  
                  <div className="lu-grid lu-grid-cols-3 lu-gap-4">
                    {/* None Animation Option */}
                    <button
                      onClick={() => handleImmediateSettingUpdate('popupAnimation', 'none')}
                      className={`lu-p-4 lu-rounded-xl lu-border ${
                        settings.customization?.popupAnimation === 'none'
                          ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                          : 'lu-border-gray-200 hover:lu-border-gray-300'
                      } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                    >
                      <div className="lu-bg-gray-100 lu-rounded-lg lu-p-4 lu-mb-3">
                        <div className="lu-relative lu-w-full lu-bg-white lu-aspect-[4/3] lu-rounded-lg lu-border lu-border-gray-200 lu-flex lu-justify-center lu-items-center">
                          {/* Static popup representation */}
                          <div className="lu-w-2/3 lu-bg-white lu-rounded-md lu-border lu-border-gray-300 lu-shadow-md">
                            <div className="lu-h-3 lu-border-b lu-border-gray-200"></div>
                            <div className="lu-px-2 lu-py-2">
                              <div className="lu-h-1 lu-w-3/4 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                              <div className="lu-h-1 lu-w-1/2 lu-bg-gray-200 lu-rounded"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <span className="lu-block lu-text-center lu-font-medium">None</span>
                      <span className="lu-block lu-text-center lu-text-xs lu-text-gray-500">Instant appearance</span>
                    </button>

                    {/* Scale Animation Option */}
                    <button
                      onClick={() => handleImmediateSettingUpdate('popupAnimation', 'scale')}
                      className={`lu-p-4 lu-rounded-xl lu-border ${
                        settings.customization?.popupAnimation === 'scale'
                          ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                          : 'lu-border-gray-200 hover:lu-border-gray-300'
                      } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                    >
                      <div className="lu-bg-gray-100 lu-rounded-lg lu-p-4 lu-mb-3">
                        <div className="lu-relative lu-w-full lu-bg-white lu-aspect-[4/3] lu-rounded-lg lu-border lu-border-gray-200 lu-flex lu-justify-center lu-items-center">
                          {/* Scale animation representation */}
                          <div className="lu-w-2/3 lu-bg-white lu-rounded-md lu-border lu-border-gray-300 lu-shadow-md lu-scale-[0.85] lu-origin-center">
                            <div className="lu-h-3 lu-border-b lu-border-gray-200"></div>
                            <div className="lu-px-2 lu-py-2">
                              <div className="lu-h-1 lu-w-3/4 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                              <div className="lu-h-1 lu-w-1/2 lu-bg-gray-200 lu-rounded"></div>
                            </div>
                          </div>
                          {/* Animation arrows */}
                          <div className="lu-absolute lu-inset-0 lu-pointer-events-none">
                            <svg className="lu-w-full lu-h-full" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M30 50 L20 40 L30 30" stroke="#10a37f" strokeWidth="2" />
                              <path d="M70 50 L80 60 L70 70" stroke="#10a37f" strokeWidth="2" />
                              <path d="M50 30 L50 20 L60 30" stroke="#10a37f" strokeWidth="2" />
                              <path d="M50 70 L50 80 L40 70" stroke="#10a37f" strokeWidth="2" />
                            </svg>
                          </div>
                        </div>
                      </div>
                      <span className="lu-block lu-text-center lu-font-medium">Scale</span>
                      <span className="lu-block lu-text-center lu-text-xs lu-text-gray-500">Zoom in effect</span>
                    </button>

                    {/* Fade Animation Option */}
                    <button
                      onClick={() => handleImmediateSettingUpdate('popupAnimation', 'fade')}
                      className={`lu-p-4 lu-rounded-xl lu-border ${
                        settings.customization?.popupAnimation === 'fade'
                          ? 'lu-border-[#10a37f] lu-ring-2 lu-ring-[#10a37f] lu-ring-opacity-20'
                          : 'lu-border-gray-200 hover:lu-border-gray-300'
                      } lu-transition-all lu-duration-200 lu-focus:lu-outline-none`}
                    >
                      <div className="lu-bg-gray-100 lu-rounded-lg lu-p-4 lu-mb-3">
                        <div className="lu-relative lu-w-full lu-bg-white lu-aspect-[4/3] lu-rounded-lg lu-border lu-border-gray-200 lu-flex lu-justify-center lu-items-center">
                          {/* Fade animation representation */}
                          <div className="lu-w-2/3 lu-bg-white lu-rounded-md lu-border lu-border-gray-300 lu-shadow-md lu-opacity-60">
                            <div className="lu-h-3 lu-border-b lu-border-gray-200"></div>
                            <div className="lu-px-2 lu-py-2">
                              <div className="lu-h-1 lu-w-3/4 lu-bg-gray-200 lu-rounded lu-mb-1"></div>
                              <div className="lu-h-1 lu-w-1/2 lu-bg-gray-200 lu-rounded"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <span className="lu-block lu-text-center lu-font-medium">Fade</span>
                      <span className="lu-block lu-text-center lu-text-xs lu-text-gray-500">Fade in effect</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </SettingsCard>

          {/* Prompt Templates */}
          <SettingsCard
            id="prompt-templates"
            title="Prompt Templates"
            icon={
              <svg xmlns="http://www.w3.org/2000/svg" className="lu-h-5 lu-w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                <path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" />
              </svg>
            }
          >
            <div className="lu-mb-4">
              <p className="lu-text-sm lu-text-gray-500 lu-mb-4">
                Customize how LightUp processes your text for each mode. You can edit both the system prompt (instructions to the AI) and the user prompt (how your text is formatted).
              </p>
              
              <div className="lu-mb-6">
                <label className="lu-block lu-mb-2 lu-text-gray-800 lu-font-medium">Select Mode</label>
                <div className="lu-grid lu-grid-cols-2 sm:lu-grid-cols-3 lu-gap-2">
                  {["explain", "summarize", "analyze", "translate", "free"].map((mode) => (
                    <button
                      key={mode}
                      onClick={() => setActivePromptMode(mode as Mode)}
                      className={`lu-px-3 lu-py-2 lu-rounded-lg lu-text-sm lu-font-medium lu-transition-colors ${
                        activePromptMode === mode
                          ? "lu-bg-[#10a37f] lu-text-white"
                          : "lu-bg-gray-100 lu-text-gray-700 hover:lu-bg-gray-200"
                      }`}
                    >
                      {mode === "explain" && "Explain"}
                      {mode === "summarize" && "Summarize"}
                      {mode === "analyze" && "Analyze"}
                      {mode === "translate" && "Translate"}
                      {mode === "free" && "Ask Anything"}
                    </button>
                  ))}
                </div>
              </div>
              
              {/* System Prompt Section */}
              <div className="lu-mb-6 lu-p-4 lu-bg-gray-50 lu-rounded-lg">
                <div className="lu-flex lu-justify-between lu-items-center lu-mb-3">
                  <h3 className="lu-text-base lu-font-semibold">System Prompt</h3>
                  <div className="lu-flex lu-gap-2">
                    <button
                      onClick={() => handleEditPrompt(activePromptMode, 'system')}
                      className="lu-text-xs lu-px-2.5 lu-py-1 lu-rounded-md lu-bg-gray-100 lu-text-gray-700 hover:lu-bg-gray-200 lu-transition-colors lu-flex lu-items-center lu-gap-1"
                    >
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                      Edit
                    </button>
                    <button
                      onClick={() => resetPromptToDefault(activePromptMode, 'system')}
                      className="lu-text-xs lu-px-2.5 lu-py-1 lu-rounded-md lu-bg-gray-100 lu-text-gray-700 hover:lu-bg-gray-200 lu-transition-colors lu-flex lu-items-center lu-gap-1"
                    >
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                      Reset
                    </button>
                  </div>
                </div>
                
                {isEditingSystemPrompt && activePromptMode ? (
                  <div>
                    <textarea
                      value={editedSystemPrompt}
                      onChange={(e) => setEditedSystemPrompt(e.target.value)}
                      className="lu-w-full lu-h-40 lu-p-2.5 lu-rounded-md lu-border lu-border-gray-300 lu-text-sm lu-font-mono lu-resize-y focus:lu-outline-none focus:lu-ring-2 focus:lu-ring-[#10a37f]/20 focus:lu-border-[#10a37f]"
                    />
                    <div className="lu-flex lu-justify-end lu-gap-2 lu-mt-2">
                      <button
                        onClick={() => setIsEditingSystemPrompt(false)}
                        className="lu-text-xs lu-px-2.5 lu-py-1 lu-rounded-md lu-bg-gray-100 lu-text-gray-700 hover:lu-bg-gray-200 lu-transition-colors"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={() => saveEditedPrompt('system')}
                        className="lu-text-xs lu-px-2.5 lu-py-1 lu-rounded-md lu-bg-[#10a37f] lu-text-white hover:lu-bg-[#0D8C6D] lu-transition-colors"
                      >
                        Save
                      </button>
                    </div>
                    <p className="lu-text-xs lu-text-gray-500 lu-mt-2">
                      The system prompt provides instructions to the AI about how to respond.
                    </p>
                  </div>
                ) : (
                  <div className="lu-bg-white lu-p-3 lu-rounded lu-border lu-border-gray-200 lu-text-sm lu-font-mono lu-whitespace-pre-wrap lu-max-h-40 lu-overflow-y-auto">
                    {getCurrentPrompts(activePromptMode).systemPrompt}
                    
                    {settings.customPrompts?.systemPrompts[activePromptMode] && (
                      <span className="lu-inline-block lu-ml-2 lu-px-2 lu-py-0.5 lu-text-xs lu-rounded-full lu-bg-blue-100 lu-text-blue-700">
                        Custom
                      </span>
                    )}
                  </div>
              </div>
            ) : (
              <div className="lu-bg-white lu-p-3 lu-rounded lu-border lu-border-gray-200 lu-text-sm lu-font-mono lu-whitespace-pre-wrap lu-max-h-40 lu-overflow-y-auto">
                {getCurrentPrompts(activePromptMode).systemPrompt}
                
                {isEditingUserPrompt && activePromptMode ? (
                  <div>
                    <textarea
                      value={editedUserPrompt}
                      onChange={(e) => setEditedUserPrompt(e.target.value)}
                      className="lu-w-full lu-h-40 lu-p-2.5 lu-rounded-md lu-border lu-border-gray-300 lu-text-sm lu-font-mono lu-resize-y focus:lu-outline-none focus:lu-ring-2 focus:lu-ring-[#10a37f]/20 focus:lu-border-[#10a37f]"
                    />
                    <div className="lu-flex lu-justify-end lu-gap-2 lu-mt-2">
                      <button
                        onClick={() => setIsEditingUserPrompt(false)}
                        className="lu-text-xs lu-px-2.5 lu-py-1 lu-rounded-md lu-bg-gray-100 lu-text-gray-700 hover:lu-bg-gray-200 lu-transition-colors"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={() => saveEditedPrompt('user')}
                        className="lu-text-xs lu-px-2.5 lu-py-1 lu-rounded-md lu-bg-[#10a37f] lu-text-white hover:lu-bg-[#0D8C6D] lu-transition-colors"
                      >
                        Save
                      </button>
                    </div>
                    <p className="lu-text-xs lu-text-gray-500 lu-mt-2">
                      Use <code className="lu-px-1 lu-py-0.5 lu-bg-gray-100 lu-rounded">${"{text}"}</code> to represent the selected text.
                      {activePromptMode === "translate" && (
                        <span> For translate mode, you can also use <code className="lu-px-1 lu-py-0.5 lu-bg-gray-100 lu-rounded">${"{fromLanguage}"}</code> and <code className="lu-px-1 lu-py-0.5 lu-bg-gray-100 lu-rounded">${"{toLanguage}"}</code>.</span>
                      )}
                    </p>
                  </div>
                ) : (
                  <div className="lu-bg-white lu-p-3 lu-rounded lu-border lu-border-gray-200 lu-text-sm lu-font-mono lu-whitespace-pre-wrap lu-max-h-40 lu-overflow-y-auto">
                    {getCurrentPrompts(activePromptMode).userPrompt}
                    
                    {settings.customPrompts?.userPrompts[activePromptMode] && (
                      <span className="lu-inline-block lu-ml-2 lu-px-2 lu-py-0.5 lu-text-xs lu-rounded-full lu-bg-blue-100 lu-text-blue-700">
                        Custom
                      </span>
                    )}
                  </div>
                )}
              </div>
              
              <div className="lu-text-xs lu-text-gray-500 lu-p-2 lu-bg-yellow-50 lu-rounded-lg">
                <p className="lu-font-semibold lu-mb-1">Template Variables:</p>
                <ul className="lu-list-disc lu-pl-4 lu-space-y-1">
                  <li><code className="lu-px-1 lu-py-0.5 lu-bg-gray-100 lu-rounded">${"{text}"}</code> - Your selected text</li>
                  {activePromptMode === "translate" && (
                    <>
                      <li><code className="lu-px-1 lu-py-0.5 lu-bg-gray-100 lu-rounded">${"{fromLanguage}"}</code> - Source language</li>
                      <li><code className="lu-px-1 lu-py-0.5 lu-bg-gray-100 lu-rounded">${"{toLanguage}"}</code> - Target language</li>
                    </>
                  )}
                </ul>
              </div>
            </div>
          </SettingsCard>
        </div>
      </div>

      {/* Fixed Save Button */}
      <motion.div 
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        className="lu-fixed lu-bottom-0 lu-left-0 lu-right-0 lu-z-50"
      >
        <div className="lu-bg-white/80 lu-backdrop-blur-md lu-border-t lu-border-gray-100 lu-shadow-lg lu-py-4">
          <div className="lu-max-w-[800px] lu-mx-auto lu-px-5">
            <div className="lu-flex lu-flex-col lu-gap-3 lu-w-full">
              {error && <ErrorMessage message={error} />}
              {saveSuccess && (
                <div className="lu-flex lu-items-center lu-justify-center lu-text-green-600 lu-bg-green-50 lu-py-2 lu-px-4 lu-rounded-lg lu-w-full">
                  <svg xmlns="http://www.w3.org/2000/svg" className="lu-h-5 lu-w-5 lu-mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 010 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                  </svg>
                  Settings saved successfully!
                </div>
              )}
              <button
                onClick={handleSave}
                disabled={isSaving}
                className="lu-w-full lu-px-4 lu-py-2.5 lu-bg-[#10a37f] hover:lu-bg-[#0D8C6D] lu-text-white lu-font-medium lu-rounded-lg lu-transition-all lu-duration-150 focus:lu-outline-none focus:lu-ring-2 focus:lu-ring-[#10a37f]/20 disabled:lu-opacity-50 lu-flex lu-items-center lu-justify-center"
              >
                {isSaving ? (
                  <>
                    <svg className="lu-animate-spin lu--ml-1 lu-mr-2 lu-h-4 lu-w-4 lu-text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle className="lu-opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="lu-opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Saving...
                  </>
                ) : "Save Settings"}
              </button>
            </div>
          </div>
        </div>
      </motion.div>

      {/* Toast */}
      <div id="toast" className="lu-fixed lu-bottom-4 lu-right-4 lu-bg-[#10a37f] lu-text-white lu-px-4 lu-py-2 lu-rounded-md lu-text-sm lu-opacity-0 lu-transition-opacity lu-duration-200 lu-shadow-md" />
    </div>
  );
}

export default IndexOptions;